name: Deploy Node Backend to EC2

on:
  push:
    branches:
      - main          # change if you deploy from another branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£  Pull the commit that triggered the workflow
      - name: üõéÔ∏è  Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£  Write the private key from GitHub Secrets ‚Üí ~/.ssh/id_rsa
      - name: üîê  Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Pre-add EC2 host to known_hosts so ssh won't ask for confirmation
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # 3Ô∏è‚É£  SSH into EC2, pull latest code and restart PM2
      - name: üöÄ  Deploy on EC2
        env:            # makes secrets available inside the heredoc
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USER }}
        run: |
          ssh -T -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no "$USER@$HOST" << 'EOF'
            set -e                           # ‚õëÔ∏è bail out on any error
            APP_DIR=~/ECommerce/server       # üìÇ update if your path differs

            # If first time, clone the repo (harmless if folder already exists)
            if [ ! -d "$APP_DIR" ]; then
              git clone https://github.com/<YOUR_GITHUB_USERNAME>/<YOUR_REPO>.git "$APP_DIR"
            fi

            cd "$APP_DIR"

            # Pull latest commit
            git pull origin main

            # Install only if lock-file or package.json changed
            npm ci --production

            # Reload if PM2 process exists, otherwise start it
            pm2 reload app --update-env || pm2 start app.js --name app

            # Persist process list on reboot
            pm2 save
          EOF
