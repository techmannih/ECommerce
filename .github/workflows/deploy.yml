name: Deploy Node Backend to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: üõéÔ∏è  Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Set up SSH Key
      - name: üîê  Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # 3Ô∏è‚É£ Deploy to EC2
      - name: üöÄ  Deploy on EC2
        env:
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USER }}
        run: |
          ssh -T -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no "$USER@$HOST" << 'EOF'
            set -e
            APP_DIR=~/ECommerce/server

            # Clone if missing
            if [ ! -d "$APP_DIR" ]; then
              git clone https://github.com/techmannih/ECommerce.git "$APP_DIR"
            fi

            cd "$APP_DIR"

            # Pull changes
            git pull origin main

            # Install dependencies
            npm ci --production

            # Restart app
            pm2 reload app --update-env || pm2 start app.js --name app

            pm2 save
          EOF
